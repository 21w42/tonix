set -x

input=$1
jq -n --arg v "$input" --slurpfile sv run/vm --rawfile aliases run/aliases --rawfile opt_string run/optstring --rawfile index run/index --rawfile pool run/pool '{sv_in: $sv[], input: $v, $aliases, $opt_string, $index, $pool}' >tmp/set_args
#~/bin/tonos-cli -j run --boc bin/eilish.boc --abi build/eilish.abi.json set_args tmp/set_args >tmp/arg_set.out
~/bin/tonos-cli -j run --boc bin/eilish.boc --abi usr/obj/eilish.abi.json set_args tmp/set_args >tmp/arg_set.out
jq 'if has("Error") then empty else . end' tmp/arg_set.out >tmp/eilish.out
jq -r 'if has("Error") then .Error else empty end' tmp/arg_set.out >tmp/eilish.err

if [ -s tmp/eilish.out ]; then
    jq -rj '.out' tmp/eilish.out >run/args
    jq '.sv' tmp/eilish.out >run/vm
    jq -rj '.p' tmp/eilish.out >run/proc_out
    eval `jq -rj '.res' tmp/eilish.out`
else
    cat tmp/eilish.err >run/stderr
fi;

./flush_std run/stdout run/stderr
